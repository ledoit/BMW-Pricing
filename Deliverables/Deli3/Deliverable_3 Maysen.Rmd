---
title: "Deliverable3"
author: "Maysen Pagan"
date: "2023-02-24"
output: pdf_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(hrbrthemes)
library(GGally)
library(kableExtra)
library(knitr)
library(car)
library(dplyr)
library(lubridate)
library(AICcmodavg)
library(leaps)
library(caret)
library(MASS)

bmw <- as_tibble(read.csv("~/Documents/BU 2023/Sp23/MA575/Lab/BMW-Pricing/BMWpricing.csv", comment.char="#")) %>% 
  select(-maker_key)
```

```{r cleaning}
#remove mileage greater than 1,000,000  and less than 0
bmw_clean <- bmw %>% filter(mileage<500000 & mileage > 0)
#remove the only car whose model_key is "ActiveHybrid 5"
bmw_clean <- bmw_clean %>%  filter(model_key != "ActiveHybrid 5")
#change true/false in features to 0/1
bmw_clean$feature_1 <- as.integer(as.logical(bmw_clean$feature_1))
bmw_clean$feature_2 <- as.integer(as.logical(bmw_clean$feature_2))
bmw_clean$feature_3 <- as.integer(as.logical(bmw_clean$feature_3))
bmw_clean$feature_4 <- as.integer(as.logical(bmw_clean$feature_4))
bmw_clean$feature_5 <- as.integer(as.logical(bmw_clean$feature_5))
bmw_clean$feature_6 <- as.integer(as.logical(bmw_clean$feature_6))
bmw_clean$feature_7 <- as.integer(as.logical(bmw_clean$feature_7))
bmw_clean$feature_8 <- as.integer(as.logical(bmw_clean$feature_8))
#separate registration date column into month, day, and year
bmw_clean[c('month', 'day', 'year')] <- str_split_fixed(bmw_clean$registration_date, '/', 3)
#create column "model_letter" containing letter of model_key (if it exists, "none" otherwise)
bmw_clean <- bmw_clean %>% mutate(model_letter = str_extract(bmw_clean$model_key, "^[A-Za-z]"))
bmw_clean$model_letter <- replace_na(bmw_clean$model_letter, "none")
#add age variable
bmw_clean$age <- as.numeric(difftime(as.Date(bmw_clean$sold_at,"%m/%d/%Y"),as.Date(bmw_clean$registration_date,"%m/%d/%Y"))/365)
# define common/uncommon colors
common_color <- c("black","grey","white","silver")
uncommon_color <-c("red", "blue","orange","beige","brown","green")
bmw_clean <- bmw_clean %>%
  #create dummy columns
  mutate(test1 = 1, test2 = 1, test3 = 1, test4 = 1) %>%  
  #determine common color 
  mutate(is_common_color = sapply(bmw_clean$paint_color, function(x) x %in% common_color )) %>%
  # extract model series 
  mutate(model_letter = substr(model_key, 1,1))

#turn logical into numeric 
bmw_clean$feature_1 <- as.numeric(bmw_clean$feature_1)
bmw_clean$feature_2 <- as.numeric(bmw_clean$feature_2)
bmw_clean$feature_3 <- as.numeric(bmw_clean$feature_3)
bmw_clean$feature_4 <- as.numeric(bmw_clean$feature_4)
bmw_clean$feature_5 <- as.numeric(bmw_clean$feature_5)
bmw_clean$feature_6 <- as.numeric(bmw_clean$feature_6)
bmw_clean$feature_7 <- as.numeric(bmw_clean$feature_7)
bmw_clean$feature_8 <- as.numeric(bmw_clean$feature_8)
bmw_clean$is_common_color <- as.numeric(bmw_clean$is_common_color)

#pivot the categorical values
bmw_clean <- bmw_clean %>% 
  pivot_wider(names_from = paint_color, values_from = test1,values_fill = 0 ) %>% 
  pivot_wider(names_from = fuel, values_from = test2, values_fill = 0 ) %>%
  pivot_wider(names_from = car_type, values_from = test3, values_fill = 0 ) %>%
  pivot_wider(names_from = model_letter, values_from = test4, values_fill = 0 )
```

2.

```{r correlation_heatmap}
# creating correlation matrix
bmw_heatmap <- subset(bmw_clean, select = c("price", "mileage", "engine_power", "age", "is_new_energy", "is_common_color", "feature_1","feature_2","feature_3","feature_4","feature_5","feature_6", "feature_7","feature_8"))

corr_mat <- round(cor(bmw_heatmap),2)
 
# reduce the size of correlation matrix
melted_corr_mat <- melt(corr_mat)
head(melted_corr_mat)
 
# plotting the correlation heatmap
ggplot(data = melted_corr_mat, aes(x=Var1, y=Var2, fill=value)) + geom_tile() + scale_fill_gradient2(low = "#075AFF", mid="#FFFFCC", high="#FF0000") + geom_text(aes(Var2, Var1, label = value), color = "black", size = 2) + scale_x_discrete(guide = guide_axis(n.dodge=3))
``` 

3.  

```{r scatterplot}
attach(bmw_clean)
data <- data.frame(price, mileage, engine_power, age, diesel, petrol, hybrid_petrol, M, Z, X, i, is_common_color)
ggpairs(data, upper = list(continuous = wrap("points", alpha = 0.3,    size=0.1)),
lower = list(continuous = wrap('cor', size = 4)))
detach(bmw_clean)
```

```{r stepwise_AIC}
library(leaps)
#full model
full_mod <- lm(price ~ mileage + engine_power + age + diesel + petrol + hybrid_petrol + M + Z + X + i + is_common_color, data = bmw_clean)

#best model using stepwise AIC
best_mod <- stepAIC(full_mod, direction = "both", trace = FALSE)
summary(best_mod)

#comparing AIC of best model against full model (and other stats)
broom::glance(best_mod)
broom::glance(full_mod)
```

```{r stepwise_Mallows}
fwd <- leaps::regsubsets(price ~ mileage + engine_power + age + diesel + petrol + hybrid_petrol + M + Z + X + i + is_common_color, 
                         data = bmw_clean, 
                         method = "forward",
                         nvmax = 12)
summary(fwd)$which
(b <- which.min(summary(fwd)$cp))
# b = 8, so a model with 8 variables has lowest Mallow's CP and is therefore the best model
#best model according to to CP and forward selection
colnames(summary(fwd)$which)[summary(fwd)$which[b,]]
#best overall model confirms that best model from stepwise AIC is correct
best_model <- (lm(price ~ mileage + engine_power + age + diesel + petrol + hybrid_petrol + X + i, bmw_clean))
summary(best_model)
```

```{r Mallows_plot}
cp <- as_tibble(matrix(summary(fwd)$cp))
predictors <- c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11)
cp %>% add_column(predictors = predictors)

#bar graph
cp %>% ggplot(aes(x = predictors, y = V1)) + 
  geom_bar(stat = "identity", color = "#1974D2", fill = "white") + 
  scale_x_continuous(n.breaks = 10) +
  geom_text(aes(label = round(V1,2)), vjust = -0.25) +
  labs(x = "Number of Predictors", y = "Mallow's CP")

#point plot
#cp %>% ggplot(aes(x = predictors, y = V1)) + 
#   geom_point() + 
#   scale_x_continuous(n.breaks = 10) +
#   geom_text(aes(label = round(V1,2)), vjust = -0.60) +
#   labs(x = "Number of Predictors", y = "Mallow's CP")
```

```{r MLR}
summary(best_mod)
```

```{r standard_resid}
#add fitted values column to data set
bmw_fitted <- cbind(bmw_clean, fitted = fitted(best_model))

standard_res <- rstandard(best_model)
plot(bmw_fitted$fitted, standard_res, 
     ylab="Standardized Residuals", 
     xlab="Fitted Values") 
abline(0, 0) 
abline(2, 0)
abline(-2, 0)
```
